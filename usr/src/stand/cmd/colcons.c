/* This appears to be a copy of /usr/sys/bmt/colour.c.
 * When I reverse engineered this, I manually generated function names
 * which do not match the public symbols in bmt/colour.c.
 */
#include "data.h"
#include <sys/bmt/gdi.h>
#include <sys/bmt/gdisys.h>
#include <sys/bmt/rtk.h>
#include <sys/bmt/cbip.h>

struct colfont {
    unsigned short cell[16];
} col_font[] = {
    {0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
     0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0c00, 0x0c00, 0x0c00, 0x0c00, 0x0c00,
     0x0c00, 0x0c00, 0x0000, 0x0c00, 0x0c00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3300, 0x3300, 0x3300, 0x3300, 0x3300,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0480, 0x0d80, 0x0900, 0x3f80, 0x1200,
     0x7f00, 0x2400, 0x6c00, 0x4800, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0400, 0x1f00, 0x3580, 0x3400, 0x3c00, 0x1f00,
     0x0780, 0x0580, 0x0580, 0x3580, 0x1f00, 0x0400, 0x0400, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x2180, 0x5100, 0x5200, 0x2600, 0x0400,
     0x0800, 0x1900, 0x1280, 0x2280, 0x6100, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1c00, 0x3600, 0x3600, 0x3600, 0x1c00,
     0x3680, 0x6380, 0x6300, 0x7780, 0x3e80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0c00, 0x0c00, 0x0c00, 0x0c00, 0x0c00,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0600, 0x0c00, 0x1800, 0x1800, 0x3000, 0x3000, 0x3000, 0x3000,
     0x3000, 0x3000, 0x3000, 0x3000, 0x1800, 0x1800, 0x0c00, 0x0600},
    {0x1800, 0x0c00, 0x0600, 0x0600, 0x0300, 0x0300, 0x0300, 0x0300,
     0x0300, 0x0300, 0x0300, 0x0300, 0x0600, 0x0600, 0x0c00, 0x1800},
    {0x0000, 0x0000, 0x0000, 0x0c00, 0x2d00, 0x3f00, 0x1e00, 0x3f00,
     0x2d00, 0x0c00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0c00, 0x0c00, 0x0c00, 0x7f80,
     0x7f80, 0x0c00, 0x0c00, 0x0c00, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0e00, 0x0e00, 0x0200, 0x0600, 0x0c00},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3f00,
     0x3f00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0c00, 0x0c00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0180, 0x0180, 0x0300, 0x0300, 0x0600, 0x0600, 0x0C00,
     0x0C00, 0x1800, 0x1800, 0x3000, 0x3000, 0x6000, 0x6000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3300, 0x3300, 0x3300,
     0x3300, 0x3300, 0x3300, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00,
     0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x2100, 0x0300, 0x0600,
     0x0C00, 0x1800, 0x3000, 0x3000, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1F00, 0x3380, 0x0180, 0x0380, 0x0F00,
     0x0300, 0x0180, 0x2180, 0x3380, 0x1F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0700, 0x0700, 0x0B00, 0x1B00, 0x1300,
     0x3300, 0x2300, 0x3F80, 0x0300, 0x0300, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x3000, 0x3000, 0x3000, 0x3E00,
     0x0300, 0x0300, 0x0300, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0E00, 0x1B00, 0x3000, 0x3000, 0x3E00,
     0x3300, 0x3300, 0x3300, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x0300, 0x0600, 0x0600, 0x0C00,
     0x0C00, 0x1800, 0x1800, 0x3000, 0x3000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3300, 0x3300, 0x1E00,
     0x3300, 0x6180, 0x6180, 0x7380, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3300, 0x3300, 0x3300,
     0x1F00, 0x0300, 0x0300, 0x3700, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0E00, 0x0E00,
     0x0000, 0x0000, 0x0000, 0x0E00, 0x0E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0E00, 0x0E00,
     0x0000, 0x0000, 0x0000, 0x0E00, 0x0E00, 0x0200, 0x0600, 0x0C00},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0300, 0x0600, 0x0C00, 0x1800,
     0x3000, 0x6000, 0x3000, 0x1800, 0x0C00, 0x0600, 0x0300, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3F00,
     0x0000, 0x3F00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x3000, 0x1800, 0x0C00, 0x0600,
     0x0300, 0x0180, 0x0300, 0x0600, 0x0C00, 0x1800, 0x3000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3300, 0x0300, 0x0600,
     0x0C00, 0x0C00, 0x0000, 0x0C00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6180, 0x6780, 0x6D80,
     0x6D80, 0x6D80, 0x6700, 0x3000, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1C00, 0x1C00, 0x3600, 0x3600, 0x3600,
     0x6300, 0x6300, 0x7F00, 0xC180, 0xC180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3E00, 0x3300, 0x3300, 0x3300, 0x3E00,
     0x3300, 0x3180, 0x3180, 0x3380, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1F00, 0x3180, 0x6180, 0x6000, 0x6000,
     0x6000, 0x6000, 0x6180, 0x3180, 0x1F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3E00, 0x3300, 0x3180, 0x3180, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3300, 0x3E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x3000, 0x3000, 0x3000, 0x3E00,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x3000, 0x3000, 0x3000, 0x3E00,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1F00, 0x3180, 0x6180, 0x6000, 0x6000,
     0x6380, 0x6180, 0x6180, 0x3380, 0x1F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x6180, 0x6180, 0x7F80,
     0x6180, 0x6180, 0x6180, 0x6180, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x0C00, 0x0C00, 0x0C00, 0x0C00,
     0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0F00, 0x0300, 0x0300, 0x0300, 0x0300,
     0x0300, 0x6300, 0x6300, 0x7700, 0x3E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6300, 0x6600, 0x6C00, 0x7800, 0x7000,
     0x7800, 0x6C00, 0x6600, 0x6300, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3000, 0x3000, 0x3000, 0x3000, 0x3000,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x7380, 0x7380, 0x7F80, 0x6D80,
     0x6D80, 0x6D80, 0x6180, 0x6180, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x7180, 0x7180, 0x7980, 0x6980, 0x6D80,
     0x6D80, 0x6580, 0x6780, 0x6780, 0x6380, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6180, 0x6180, 0x6180,
     0x6180, 0x6180, 0x6180, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x3380, 0x3180, 0x3180, 0x3380,
     0x3F00, 0x3000, 0x3000, 0x3000, 0x3000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6180, 0x6180, 0x6180,
     0x6180, 0x6180, 0x6180, 0x3300, 0x1E00, 0x0600, 0x0300, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x7E00, 0x6700, 0x6300, 0x6300, 0x6700,
     0x7E00, 0x6C00, 0x6600, 0x6300, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6100, 0x7000, 0x3C00,
     0x0F00, 0x0380, 0x6180, 0x7380, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x7F80, 0x0C00, 0x0C00, 0x0C00, 0x0C00,
     0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x6180, 0x6180, 0x6180,
     0x6180, 0x6180, 0x6180, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x6180, 0x3300, 0x3300,
     0x3300, 0x1E00, 0x1E00, 0x0C00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x6180, 0x6180, 0x6D80,
     0x6D80, 0x2D00, 0x3F00, 0x3300, 0x1200, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x3300, 0x3300, 0x1E00,
     0x1E00, 0x3300, 0x3300, 0x6180, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x3300, 0x3300, 0x1E00,
     0x1E00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F80, 0x0180, 0x0180, 0x0300, 0x0600,
     0x0C00, 0x1800, 0x3000, 0x3000, 0x3F80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x3E00, 0x3000, 0x3000, 0x3000, 0x3000, 0x3000,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x3E00},
    {0x0000, 0x6000, 0x6000, 0x3000, 0x3000, 0x1800, 0x1800, 0x0C00,
     0x0C00, 0x0600, 0x0600, 0x0300, 0x0300, 0x0180, 0x0180, 0x0000},
    {0x0000, 0x0000, 0x3E00, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600,
     0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x3E00},
    {0x0000, 0x0000, 0x0000, 0x1C00, 0x3600, 0x6300, 0xC180, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
     0x0000, 0x0000, 0x0000, 0xFF80, 0xFF80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0C00, 0x0600, 0x0300, 0x0180, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1E00, 0x3700, 0x0300,
     0x3B00, 0x7700, 0x6300, 0x7700, 0x3B80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x3000, 0x3000, 0x3000, 0x3700, 0x3B80, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3B80, 0x3700, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0F00, 0x1980, 0x3000,
     0x3000, 0x3000, 0x3000, 0x1980, 0x0F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0300, 0x0300, 0x0300, 0x3B00, 0x7700, 0x6300,
     0x6300, 0x6300, 0x6300, 0x7700, 0x3B00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0E00, 0x1B00, 0x3180,
     0x3F80, 0x3000, 0x3000, 0x3980, 0x1F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0F00, 0x1980, 0x1800, 0x7E00, 0x1800, 0x1800,
     0x1800, 0x1800, 0x1800, 0x1800, 0x1800, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3B00, 0x6700, 0x6300,
     0x6300, 0x6300, 0x6300, 0x7700, 0x3B00, 0x0300, 0x6700, 0x3E00},
    {0x0000, 0x0000, 0x3000, 0x3000, 0x3000, 0x3700, 0x3B80, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3180, 0x3180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0600, 0x0600, 0x0000, 0x1E00, 0x0600, 0x0600,
     0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0600, 0x0600, 0x0000, 0x1E00, 0x0600, 0x0600,
     0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x6600, 0x6600, 0x3C00},
    {0x0000, 0x0000, 0x3000, 0x3000, 0x3180, 0x3300, 0x3600, 0x3C00,
     0x3C00, 0x3600, 0x3300, 0x3300, 0x3180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x1E00, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600,
     0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x7F00, 0x6D80, 0x6D80,
     0x6D80, 0x6D80, 0x6D80, 0x6D80, 0x6D80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3700, 0x3B80, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3180, 0x3180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6180,
     0x6180, 0x6180, 0x6180, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3700, 0x3B80, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3B80, 0x3700, 0x3000, 0x3000, 0x3000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3B00, 0x6700, 0x6300,
     0x6300, 0x6300, 0x6300, 0x7700, 0x3B00, 0x0300, 0x0300, 0x0300},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3700, 0x3B00, 0x3000,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3000,
     0x3C00, 0x0F00, 0x0300, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1800, 0x1800, 0x7E00, 0x1800, 0x1800,
     0x1800, 0x1800, 0x1800, 0x1B00, 0x0E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x6300, 0x6300, 0x6300,
     0x6300, 0x6300, 0x6300, 0x6700, 0x3B00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x3300,
     0x3300, 0x3300, 0x1E00, 0x1E00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xC0C0, 0xC0C0, 0xCCC0,
     0x6D80, 0x6D80, 0x3F00, 0x3300, 0x3300, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x6300, 0x6300, 0x3600,
     0x1C00, 0x1C00, 0x3600, 0x6300, 0x6300, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x3300,
     0x3300, 0x1200, 0x1E00, 0x1E00, 0x0C00, 0x0C00, 0x6C00, 0x3800},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3F80, 0x0180, 0x0300,
     0x0600, 0x0C00, 0x1800, 0x3000, 0x3F80, 0x0000, 0x0000, 0x0000},
    {0x0700, 0x0C00, 0x1800, 0x1800, 0x1800, 0x1800, 0x3000, 0x6000,
     0x3000, 0x1800, 0x1800, 0x1800, 0x1800, 0x0C00, 0x0700, 0x0000},
    {0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00,
     0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0000, 0x0000},
    {0x3800, 0x0C00, 0x0600, 0x0600, 0x0600, 0x0600, 0x0300, 0x0180,
     0x0300, 0x0600, 0x0600, 0x0600, 0x0600, 0x0C00, 0x3800, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x1840, 0x3D80, 0x6F00, 0x8600,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000}
};

col_write(ch)
int ch;
{
    col_clearcell();
    col_writech(ch & 0x7f);
    col_writedel();
}

col_writedel()
{
    col_writech(0x1f);
    col_writech(0x08);
}

col_clearcell()
{
    col_writech(' ');
    col_writech(0x08);
}

col_writech(ch)
int ch;
{
    if (ch == '\n') {
        col_column = 0;
        col_line++;
    } else if (ch == '\r') {
        col_column = 0;
    } else if (ch == '\t') {
        do {
            col_writech(' ');
        } while ((col_column & 0x07) != 0);
    } else if (ch == 0x08) {
        if (col_column > 0)
            col_column--;
    } else {
        if (ch < 0x1f || ch >= 0x7f)
            ch = 0x1f;
        if (col_column >= 128)
            col_writech('\n');
        if (col_line >= 64) {
            col_scrollup(16);
            col_line = 63;
        }
        col_bltchar(&col_font[ch-0x1f]);
        col_column++;
        if (col_column >= 128)
            col_writech('\n');
    }
    
    if (col_line >= 64) {
        col_scrollup(16);
        col_line = 63;
    }
}

col_bltchar(bitmap)
unsigned short *bitmap;
{
    int i;
    register unsigned int bits;
    register unsigned int cell;
    register char *base = (char*)(COLORRAM + (col_line << 14) + (col_column * 5));
    
    for (i=0; i < 16; i++) {
        cell = (unsigned int)*bitmap++;
        bits = 0;
        if (cell & 0x8000) bits = 0x10;
        if (cell & 0x4000) bits |= 0x01;
        *base++ = bits;
        bits = 0;
        if (cell & 0x2000) bits = 0x10;
        if (cell & 0x1000) bits |= 0x01;
        *base++ = bits;
        bits = 0;
        if (cell & 0x0800) bits = 0x10;
        if (cell & 0x0400) bits |= 0x01;
        *base++ = bits;
        bits = 0;
        if (cell & 0x0200) bits = 0x10;
        if (cell & 0x0100) bits |= 0x01;
        *base++ = bits;
        bits = 0;
        if (cell & 0x0080) bits = 0x10;
        if (cell & 0x0040) bits |= 0x01;
        *base++ = bits;
    }
}

col_scrollup(lines)
int lines;
{
    register int i,k;
    register long *base, *from, *to;

    base = (long*)COLORRAM;
    to = base;
    from = &base[lines*256];

    for (k =0; (k+lines) < 1024; k++) { /* 1024 scan lines */
        for (i = 40; i > 0; i--) {      /* 40 longs = 160 chars per line */
            *to++ = *from++;
            *to++ = *from++;
            *to++ = *from++;
            *to++ = *from++;
        }
        from += 96;
        to += 96;
    }
    for ( ; k < 1024; k++) {            /* clear last lines */
        for (i=40; i > 0; i--) {
            *to++ = 0;
            *to++ = 0;
            *to++ = 0;
            *to++ = 0;
        }
        to += 96;
    }
}

col_init()
{
    static int colinit;
    if (colinit)
        return;
    
    colinit++;
    
    col_setcolor(0, 255, 255, 255);     /* palette index 0 = RGB=(255,255,255) */
    col_setcolor(1, 0, 0, 0);           /* palette index 1 = RGB=(0,0,0) */
    col_setcolor(8, 0, 0, 0);           /* palette index 8 = RGB=(0,0,0) */

    col_scrollup(1024);                 /* clear screen */

    col_column = 0;
    col_line = 0;

    col_3FF83A20();                     /* not clear what this does */
}

#define NOPINSTR() 0x4e71

/* initialize the SCC for keyboard */
col_3FF83A20()
{
    register long *scc = (long*)(CBIP_IOBASE+SCC_OFFSET+8);
    int save = *(long*)COLORRAM;
    
    /* see /usr/sys/bmt/kscc.c for details */
    *scc = 9; *scc = 0xc0;      /* register WR9, reset both channels */
    NOPINSTR();
    NOPINSTR();
    NOPINSTR();
    NOPINSTR();
    *scc = 9;   *scc = 9;       /* register WR9, VIS & MIE bits */
    NOPINSTR();
    NOPINSTR();
    NOPINSTR();
    NOPINSTR();
    *scc = 9;   *scc = 0xc0;    /* register WR9, reset both channels */
    *scc = 4;   *scc = 0x44;    /* register WR4, X16 clock an 1 stopbit */
    *scc = 5;   *scc = 0x60;    /* register WR5, TX 8 bits */
    *scc = 3;   *scc = 0xC0;    /* register WR3, RX 8 bits */
    *scc = 11;  *scc = 0x52;    /* register WR11, RXBR, TXBR, TRxCBR */
    *scc = 12;  *scc = 0x6c;    /* register WR12/13, 1200 bd */
    *scc = 13;  *scc = 0x0d;
    *scc = 14;  *scc = 0x02;    /* register WR14, BR Generator source */
    *scc = 14;  *scc = 0x03;    /* register WR14, BR enable */
    *scc = 5;   *scc = 0xea;    /* register WR5, DTR, TX 8 bits, 1,5 stop bits , no parity */
    *scc = 3;   *scc = 0xc1;    /* register WR3, RX 8 bits RX enable */
    *scc = 0;   *scc = 0x10;    /* register WR0, Reset interrupts */
    *scc = 0;   *scc = 0x10;    /* register WR0, Reset interrupts */
    *scc = 15;  *scc = 0x00;    /* register WR15, no interrupts */
}

/* set palette */
col_setcolor(idx, g, r, b)
int idx, r, g, b;
{
    register long *monoff = (long*)(CBIP_IOBASE+MON_OFFSET);
    register long *palette= (long*)CBIP_IOBASE;
    int save = *(long*)COLORRAM;

    palette += (idx & 0x0f) << 1;
    *palette = r;
    palette += 256;
    *palette = g;
    palette += 256;
    *palette = b;
}

int col_read()
{
    register long *scc = (long*)(CBIP_IOBASE+SCC_OFFSET+8);
    int save = *(long*)COLORRAM;
    int ch;

    do {
        *scc = 0;
    } while ((*scc & 1)==0);
    ch = ((char*)scc)[7];
    return ch;
}

int col_haschar()
{
    register long *scc = (long*)(CBIP_IOBASE+SCC_OFFSET+8);
    int save = *(long*)COLORRAM;
    *scc = 0;
    return *scc & 1;
}
