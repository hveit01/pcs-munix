/* PCS specific */

/* Colour handling CBIP devices */

/* It was helpful to first reverse engineer the MINITOR ROM (/usr/src/stand/*),
 * because besides MINITOR handling only one device, it is the same code logic */

#include <sys/types.h>
#include <sys/param.h>
#include <sys/systm.h>
#include <sys/sysmacros.h>
#include <sys/dir.h>
#include <sys/signal.h>
#include <sys/user.h>
#include <sys/errno.h>
#include <sys/var.h>
#include <sys/page.h>
#include <sys/region.h>
#include <sys/tty.h>
#include <sys/ttold.h>
#include <sys/proc.h>
#include <sys/file.h>
#include <sys/conf.h>
#include <sys/termio.h>
#include <sys/sysinfo.h>
#include <sys/cadmaus.h>

#define CWS1
#include <sys/bmt/gdi.h>
#include <sys/bmt/gdisys.h>
#include <sys/bmt/rtk.h>
#include <sys/bmt/Bitmap.h>
#include <sys/bmt/cbip.h>
#include <sys/bmt/device.h>
#include <sys/bmt/list.h>
#include <sys/bmt/Layer.h>
#include <sys/bmt/font.h>

static char *_Version = "@(#) RELEASE: 6.3 86/12/05 /usr/sys/bmt/colour.c";

/* should have been defined in cbip.h, but isn't */
#define COLORBASE   0xb0000000

struct colfont {
    unsigned short cell[16];
} colfont[] = {
    {0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
     0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0c00, 0x0c00, 0x0c00, 0x0c00, 0x0c00,
     0x0c00, 0x0c00, 0x0000, 0x0c00, 0x0c00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3300, 0x3300, 0x3300, 0x3300, 0x3300,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0480, 0x0d80, 0x0900, 0x3f80, 0x1200,
     0x7f00, 0x2400, 0x6c00, 0x4800, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0400, 0x1f00, 0x3580, 0x3400, 0x3c00, 0x1f00,
     0x0780, 0x0580, 0x0580, 0x3580, 0x1f00, 0x0400, 0x0400, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x2180, 0x5100, 0x5200, 0x2600, 0x0400,
     0x0800, 0x1900, 0x1280, 0x2280, 0x6100, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1c00, 0x3600, 0x3600, 0x3600, 0x1c00,
     0x3680, 0x6380, 0x6300, 0x7780, 0x3e80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0c00, 0x0c00, 0x0c00, 0x0c00, 0x0c00,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0600, 0x0c00, 0x1800, 0x1800, 0x3000, 0x3000, 0x3000, 0x3000,    
     0x3000, 0x3000, 0x3000, 0x3000, 0x1800, 0x1800, 0x0c00, 0x0600},
    {0x1800, 0x0c00, 0x0600, 0x0600, 0x0300, 0x0300, 0x0300, 0x0300,
     0x0300, 0x0300, 0x0300, 0x0300, 0x0600, 0x0600, 0x0c00, 0x1800},
    {0x0000, 0x0000, 0x0000, 0x0c00, 0x2d00, 0x3f00, 0x1e00, 0x3f00,
     0x2d00, 0x0c00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0c00, 0x0c00, 0x0c00, 0x7f80,
     0x7f80, 0x0c00, 0x0c00, 0x0c00, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0e00, 0x0e00, 0x0200, 0x0600, 0x0c00},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3f00,
     0x3f00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0c00, 0x0c00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0180, 0x0180, 0x0300, 0x0300, 0x0600, 0x0600, 0x0C00,
     0x0C00, 0x1800, 0x1800, 0x3000, 0x3000, 0x6000, 0x6000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3300, 0x3300, 0x3300,
     0x3300, 0x3300, 0x3300, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00,
     0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x2100, 0x0300, 0x0600,
     0x0C00, 0x1800, 0x3000, 0x3000, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1F00, 0x3380, 0x0180, 0x0380, 0x0F00,
     0x0300, 0x0180, 0x2180, 0x3380, 0x1F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0700, 0x0700, 0x0B00, 0x1B00, 0x1300,
     0x3300, 0x2300, 0x3F80, 0x0300, 0x0300, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x3000, 0x3000, 0x3000, 0x3E00,
     0x0300, 0x0300, 0x0300, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0E00, 0x1B00, 0x3000, 0x3000, 0x3E00,
     0x3300, 0x3300, 0x3300, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x0300, 0x0600, 0x0600, 0x0C00,
     0x0C00, 0x1800, 0x1800, 0x3000, 0x3000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3300, 0x3300, 0x1E00,
     0x3300, 0x6180, 0x6180, 0x7380, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3300, 0x3300, 0x3300,
     0x1F00, 0x0300, 0x0300, 0x3700, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0E00, 0x0E00,
     0x0000, 0x0000, 0x0000, 0x0E00, 0x0E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0E00, 0x0E00,
     0x0000, 0x0000, 0x0000, 0x0E00, 0x0E00, 0x0200, 0x0600, 0x0C00},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0300, 0x0600, 0x0C00, 0x1800,
     0x3000, 0x6000, 0x3000, 0x1800, 0x0C00, 0x0600, 0x0300, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3F00,
     0x0000, 0x3F00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x3000, 0x1800, 0x0C00, 0x0600,
     0x0300, 0x0180, 0x0300, 0x0600, 0x0C00, 0x1800, 0x3000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3300, 0x0300, 0x0600,
     0x0C00, 0x0C00, 0x0000, 0x0C00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6180, 0x6780, 0x6D80,
     0x6D80, 0x6D80, 0x6700, 0x3000, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1C00, 0x1C00, 0x3600, 0x3600, 0x3600,
     0x6300, 0x6300, 0x7F00, 0xC180, 0xC180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3E00, 0x3300, 0x3300, 0x3300, 0x3E00,
     0x3300, 0x3180, 0x3180, 0x3380, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1F00, 0x3180, 0x6180, 0x6000, 0x6000,
     0x6000, 0x6000, 0x6180, 0x3180, 0x1F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3E00, 0x3300, 0x3180, 0x3180, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3300, 0x3E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x3000, 0x3000, 0x3000, 0x3E00,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x3000, 0x3000, 0x3000, 0x3E00,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1F00, 0x3180, 0x6180, 0x6000, 0x6000,
     0x6380, 0x6180, 0x6180, 0x3380, 0x1F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x6180, 0x6180, 0x7F80,
     0x6180, 0x6180, 0x6180, 0x6180, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x0C00, 0x0C00, 0x0C00, 0x0C00,
     0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0F00, 0x0300, 0x0300, 0x0300, 0x0300,
     0x0300, 0x6300, 0x6300, 0x7700, 0x3E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6300, 0x6600, 0x6C00, 0x7800, 0x7000,
     0x7800, 0x6C00, 0x6600, 0x6300, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3000, 0x3000, 0x3000, 0x3000, 0x3000,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x7380, 0x7380, 0x7F80, 0x6D80,
     0x6D80, 0x6D80, 0x6180, 0x6180, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x7180, 0x7180, 0x7980, 0x6980, 0x6D80,
     0x6D80, 0x6580, 0x6780, 0x6780, 0x6380, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6180, 0x6180, 0x6180,
     0x6180, 0x6180, 0x6180, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F00, 0x3380, 0x3180, 0x3180, 0x3380,
     0x3F00, 0x3000, 0x3000, 0x3000, 0x3000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6180, 0x6180, 0x6180,
     0x6180, 0x6180, 0x6180, 0x3300, 0x1E00, 0x0600, 0x0300, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x7E00, 0x6700, 0x6300, 0x6300, 0x6700,
     0x7E00, 0x6C00, 0x6600, 0x6300, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6100, 0x7000, 0x3C00,
     0x0F00, 0x0380, 0x6180, 0x7380, 0x3F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x7F80, 0x0C00, 0x0C00, 0x0C00, 0x0C00,
     0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x6180, 0x6180, 0x6180,
     0x6180, 0x6180, 0x6180, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x6180, 0x3300, 0x3300,
     0x3300, 0x1E00, 0x1E00, 0x0C00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x6180, 0x6180, 0x6D80,
     0x6D80, 0x2D00, 0x3F00, 0x3300, 0x1200, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x3300, 0x3300, 0x1E00,
     0x1E00, 0x3300, 0x3300, 0x6180, 0x6180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x3300, 0x3300, 0x1E00,
     0x1E00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x3F80, 0x0180, 0x0180, 0x0300, 0x0600,
     0x0C00, 0x1800, 0x3000, 0x3000, 0x3F80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x3E00, 0x3000, 0x3000, 0x3000, 0x3000, 0x3000,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x3E00},
    {0x0000, 0x6000, 0x6000, 0x3000, 0x3000, 0x1800, 0x1800, 0x0C00,
     0x0C00, 0x0600, 0x0600, 0x0300, 0x0300, 0x0180, 0x0180, 0x0000},
    {0x0000, 0x0000, 0x3E00, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600,
     0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x3E00},
    {0x0000, 0x0000, 0x0000, 0x1C00, 0x3600, 0x6300, 0xC180, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
     0x0000, 0x0000, 0x0000, 0xFF80, 0xFF80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0C00, 0x0600, 0x0300, 0x0180, 0x0000,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1E00, 0x3700, 0x0300,
     0x3B00, 0x7700, 0x6300, 0x7700, 0x3B80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x3000, 0x3000, 0x3000, 0x3700, 0x3B80, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3B80, 0x3700, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0F00, 0x1980, 0x3000,
     0x3000, 0x3000, 0x3000, 0x1980, 0x0F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0300, 0x0300, 0x0300, 0x3B00, 0x7700, 0x6300,
     0x6300, 0x6300, 0x6300, 0x7700, 0x3B00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0E00, 0x1B00, 0x3180,
     0x3F80, 0x3000, 0x3000, 0x3980, 0x1F00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0F00, 0x1980, 0x1800, 0x7E00, 0x1800, 0x1800,
     0x1800, 0x1800, 0x1800, 0x1800, 0x1800, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3B00, 0x6700, 0x6300,
     0x6300, 0x6300, 0x6300, 0x7700, 0x3B00, 0x0300, 0x6700, 0x3E00},
    {0x0000, 0x0000, 0x3000, 0x3000, 0x3000, 0x3700, 0x3B80, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3180, 0x3180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0600, 0x0600, 0x0000, 0x1E00, 0x0600, 0x0600,
     0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0600, 0x0600, 0x0000, 0x1E00, 0x0600, 0x0600,
     0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x6600, 0x6600, 0x3C00},
    {0x0000, 0x0000, 0x3000, 0x3000, 0x3180, 0x3300, 0x3600, 0x3C00,
     0x3C00, 0x3600, 0x3300, 0x3300, 0x3180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x1E00, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600,
     0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x7F00, 0x6D80, 0x6D80,
     0x6D80, 0x6D80, 0x6D80, 0x6D80, 0x6D80, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3700, 0x3B80, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3180, 0x3180, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x6180,
     0x6180, 0x6180, 0x6180, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3700, 0x3B80, 0x3180,
     0x3180, 0x3180, 0x3180, 0x3B80, 0x3700, 0x3000, 0x3000, 0x3000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3B00, 0x6700, 0x6300,
     0x6300, 0x6300, 0x6300, 0x7700, 0x3B00, 0x0300, 0x0300, 0x0300},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3700, 0x3B00, 0x3000,
     0x3000, 0x3000, 0x3000, 0x3000, 0x3000, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1E00, 0x3300, 0x3000,
     0x3C00, 0x0F00, 0x0300, 0x3300, 0x1E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x1800, 0x1800, 0x7E00, 0x1800, 0x1800,
     0x1800, 0x1800, 0x1800, 0x1B00, 0x0E00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x6300, 0x6300, 0x6300,
     0x6300, 0x6300, 0x6300, 0x6700, 0x3B00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x3300,
     0x3300, 0x3300, 0x1E00, 0x1E00, 0x0C00, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xC0C0, 0xC0C0, 0xCCC0,
     0x6D80, 0x6D80, 0x3F00, 0x3300, 0x3300, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x6300, 0x6300, 0x3600,
     0x1C00, 0x1C00, 0x3600, 0x6300, 0x6300, 0x0000, 0x0000, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x6180, 0x6180, 0x3300,
     0x3300, 0x1200, 0x1E00, 0x1E00, 0x0C00, 0x0C00, 0x6C00, 0x3800},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3F80, 0x0180, 0x0300,
     0x0600, 0x0C00, 0x1800, 0x3000, 0x3F80, 0x0000, 0x0000, 0x0000},
    {0x0700, 0x0C00, 0x1800, 0x1800, 0x1800, 0x1800, 0x3000, 0x6000,
     0x3000, 0x1800, 0x1800, 0x1800, 0x1800, 0x0C00, 0x0700, 0x0000},
    {0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00,
     0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0C00, 0x0000, 0x0000},
    {0x3800, 0x0C00, 0x0600, 0x0600, 0x0600, 0x0600, 0x0300, 0x0180,
     0x0300, 0x0600, 0x0600, 0x0600, 0x0600, 0x0C00, 0x3800, 0x0000},
    {0x0000, 0x0000, 0x0000, 0x0000, 0x1840, 0x3D80, 0x6F00, 0x8600,
     0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000}
};

extern short colcurs_x[NCBMT], colcurs_y[NCBMT];

col_putchar(dev, ch)
int dev;
int ch;
{
    cursoff(dev);
    colput__(dev, ch & 0x7f);
    curson(dev);
}

curson(dev)
int dev;
{
    colput__(dev, 0x1f); /* all pixels set */
    colput__(dev, 0x08); /* backspace */
}

cursoff(dev)
int dev;
{
    colput__(dev, ' '); /* space, all pixels clear */
    colput__(dev, 0x08); /* backspace */
}

colput__(dev, ch)
int dev;
register int ch;
{
    if (ch == '\n') {
        colcurs_x[dev] = 0;
        colcurs_y[dev]++;
    } else if (ch == '\r') {
        colcurs_x[dev] = 0;
    } else if (ch == 0x0c) {
        colcurs_x[dev] = 0;
        colcurs_y[dev] = 0;
        scroll(dev, 1024);
    } else if (ch == '\t') {
        do {
            colput__(dev, ' ');
        } while ((colcurs_x[dev] & 0x07) != 0);
    } else if (ch == 0x08) {
        if (colcurs_x[dev] > 0)
            colcurs_x[dev]--;
    } else {
        if (ch < 0x1f || ch >= 0x7f)
            ch = 0x1f;
        if (colcurs_x[dev] >= 128)
            colput__(dev, '\n');
        if (colcurs_y[dev] >= 64) {
            scroll(dev, 16);
            colcurs_y[dev] = 63;
        }
        drawchar(dev, &colfont[ch-0x1f]);
        colcurs_x[dev]++;
        if (colcurs_x[dev] >= 128)
            colput__(dev, '\n');
    }
    if (colcurs_y[dev] >= 64) {
        scroll(dev, 16);
        colcurs_y[dev] = 63;
    }
}

static drawchar(dev, bitmap)
int dev;
unsigned short *bitmap;
{
    int i;
    register unsigned int bits;
    register unsigned int cell;
    register char *base = &((char*)(colcurs_y[dev] << 14))[COLORBASE] + 
        (colcurs_x[dev] * 5);

    base += (dev << 20); 

    for (i = 0; i < (BITS_PER_WORD/2); i++) {
        cell = (unsigned int)*bitmap++;
        bits = 0;
        if (cell & 0x8000) bits = 0x10;
        if (cell & 0x4000) bits |= 0x01;
        *base++ = bits;
        bits = 0;
        if (cell & 0x2000) bits = 0x10;
        if (cell & 0x1000) bits |= 0x01;
        *base++ = bits;
        bits = 0;
        if (cell & 0x0800) bits = 0x10;
        if (cell & 0x0400) bits |= 0x01;
        *base++ = bits;
        bits = 0;
        if (cell & 0x0200) bits = 0x10;
        if (cell & 0x0100) bits |= 0x01;
        *base++ = bits;
        bits = 0;
        if (cell & 0x0080) bits = 0x10;
        if (cell & 0x0040) bits |= 0x01;
        *base++ = bits;

        base += (1024 - 5);
    }
}

static scroll(dev, nline)
int dev;
int nline;
{
    register int i, k;
    register char *base;
    register long *from, *to;

    base = (char*)COLORBASE;
    base += (dev << 20);

    to = (long*)base;
    from = (long*)(base + nline * 1024);

    for (k =0; (k+nline) < 1024; k++) { /* 1024 scan lines */
        for (i = 40; i > 0; i--) {      /* 40 longs = 160 chars per line */
            *to++ = *from++;
            *to++ = *from++;
            *to++ = *from++;
            *to++ = *from++;
        }
        from += 96;
        to += 96;
    }
    for ( ; k < 1024; k++) {            /* clear last lines */
        for (i=40; i > 0; i--) {
            *to++ = 0;
            *to++ = 0;
            *to++ = 0;
            *to++ = 0;
        }
        to += 96;
    }
}

col_init(dev)
int dev;
{
    register int dev;
    static int initdone;

    if (initdone)
        return;
    initdone++;
    
    for (dev=0; dev < NCBMT; dev++) {
        if (storacc((dev<<20) - 0x10000000) != 0) {
            lut(dev, 0, 255,255,255);
            lut(dev, 1, 0,  0,  0);
            lut(dev, 8, 0,  0,  0);
            scroll(dev, 1024);
        }
    }
}

/* interesting color sequence, not RGB, but GRB */
static lut(dev, idx, g, r, b)
int dev;
int idx;
int g, r, b;
{
    register long *mon = (long*)(CBIP_IOBASE + MON_OFFSET);
    register long *clut = (long*)CBIP_IOBASE;
    
    (char*)mon += (dev << 20);
    (char*)clut += (dev << 20);

    while ((*mon & 0x80) == 0); /* wait for ready */
    
    clut += idx & COLOR_MASK;
    *clut = r;
    clut += 256;
    *clut = g;
    clut += 256;
    *clut = b;
}

/* see kscc.c for details */
struct z85c30 {
    int cmd;
    int data;
};

int col_getchar(dev)
int dev;
{
    register int ch;
    register struct z85c30 *scc = (struct z85c30*)
        (CBIP_IOBASE + SCC_OFFSET + SCCB*sizeof(struct z85c30));

    ((char*)scc) += (dev << 20);

    while ((scc->cmd & 1)==0);  /* wait for char */
    ch = scc->data;
    scc->cmd = 0;       /* WR0 */
    scc->cmd = 0x38;    /* WRO_RSTHIUS */
    return ch & 0xff;
}
